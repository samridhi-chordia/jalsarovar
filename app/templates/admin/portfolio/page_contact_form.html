{% extends "base.html" %}
{% block title %}Edit Contact Page - Portfolio CMS{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2><i class="bi bi-envelope"></i> Edit Contact Page</h2>
        {% if is_draft %}
        <span class="badge bg-warning">Draft</span>
        {% endif %}
    </div>
    <a href="{{ url_for('admin_portfolio.list_pages') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Pages
    </a>
</div>

<form method="POST" id="contact-page-form" enctype="multipart/form-data">
    <div class="row">
        <!-- Main Content -->
        <div class="col-md-9">

            <!-- Hero Section -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-star"></i> Hero Section</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Title <span class="text-danger">*</span></label>
                        <input type="text" name="hero_title" class="form-control"
                               value="{{ page.hero.title if page else 'Get in Touch' }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Subtitle <span class="text-danger">*</span></label>
                        <input type="text" name="hero_subtitle" class="form-control"
                               value="{{ page.hero.subtitle if page else 'Let\'s collaborate on meaningful projects' }}" required>
                    </div>
                </div>
            </div>

            <!-- Intro Section -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-chat-left-text"></i> Introduction</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Heading</label>
                        <input type="text" name="intro_heading" class="form-control"
                               value="{{ page.intro.heading if page else 'Let\'s Connect' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Intro Text</label>
                        <input type="text" name="intro_text" class="form-control"
                               value="{{ page.intro.text if page else 'I\'m always interested in collaborating on projects related to:' }}">
                    </div>
                </div>
            </div>

            <!-- Interest Areas -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-list-ul"></i> Interest Areas</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Interest Areas <span class="text-danger">*</span></label>
                        <textarea name="interest_areas" class="form-control" rows="6" required
                                  placeholder="One interest per line">{{ page.interest_areas|join('\n') if page else 'Machine Learning for social impact\nResearch in renewable energy and sustainability\nEducational technology and STEM outreach\nSoftware development projects\nEnvironmental conservation initiatives' }}</textarea>
                        <small class="text-muted">One interest per line</small>
                    </div>
                </div>
            </div>

            <!-- Contact Details -->
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-person-lines-fill"></i> Contact Information</h5>
                    <button type="button" class="btn btn-sm btn-primary" onclick="addContactDetail()">
                        <i class="bi bi-plus-circle"></i> Add Contact Method
                    </button>
                </div>
                <div class="card-body">
                    <div id="contact-details-container">
                        <!-- Contact details will be added here dynamically -->
                    </div>
                    <input type="hidden" name="contact_details_json" id="contact-details-json">
                </div>
            </div>

            <!-- Resume Section -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-file-earmark-pdf"></i> Resume Download</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" name="resume_enabled" class="form-check-input"
                                   {{ 'checked' if page and page.resume.enabled else 'checked' }}>
                            <label class="form-check-label">Show resume download section</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Heading</label>
                        <input type="text" name="resume_heading" class="form-control"
                               value="{{ page.resume.heading if page else 'Resume' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea name="resume_description" class="form-control" rows="2">{{ page.resume.description if page else 'Download my complete resume for detailed information about my work and achievements.' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Button Text</label>
                        <input type="text" name="resume_button_text" class="form-control"
                               value="{{ page.resume.button_text if page else 'Download Resume (PDF)' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Upload New Resume (PDF)</label>
                        <input type="file" name="resume_file" class="form-control" accept=".pdf">
                        {% if page and page.resume.file_path %}
                        <small class="text-muted">Current file: {{ page.resume.file_path }}</small>
                        <input type="hidden" name="resume_file_path" value="{{ page.resume.file_path }}">
                        <br>
                        <a href="{{ url_for('static', filename=page.resume.file_path) }}" target="_blank" class="btn btn-sm btn-outline-info mt-2">
                            <i class="bi bi-download"></i> View Current Resume
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Form Settings -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-ui-checks"></i> Contact Form Settings</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Form Heading</label>
                        <input type="text" name="form_heading" class="form-control"
                               value="{{ page.form.heading if page else 'Send a Message' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Form Intro</label>
                        <input type="text" name="form_intro" class="form-control"
                               value="{{ page.form.intro if page else 'Have a question or want to collaborate? Fill out the form below!' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Response Time Note</label>
                        <input type="text" name="form_response_time" class="form-control"
                               value="{{ page.form.response_time if page else 'I typically respond within 2-3 business days.' }}">
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-md-3">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header">
                    <h5 class="mb-0">Actions</h5>
                </div>
                <div class="card-body">
                    <button type="submit" name="action" value="save_draft" class="btn btn-warning w-100 mb-2">
                        <i class="bi bi-save"></i> Save Draft
                    </button>
                    <button type="submit" name="action" value="publish" class="btn btn-success w-100 mb-2"
                            onclick="return confirm('Publish this page to the live site?');">
                        <i class="bi bi-cloud-upload"></i> Publish
                    </button>
                    <a href="{{ url_for('portfolio.contact') }}" target="_blank" class="btn btn-outline-info w-100">
                        <i class="bi bi-eye"></i> Preview
                    </a>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
// Initialize data
let contactDetails = {{ page.contact_details|tojson if page else '[]'|safe }};

// Contact Details Management
function renderContactDetails() {
    const container = document.getElementById('contact-details-container');
    container.innerHTML = '';

    contactDetails.forEach((detail, index) => {
        const div = document.createElement('div');
        div.className = 'card mb-3';
        div.innerHTML = `
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2 mb-2">
                        <label class="form-label">Icon</label>
                        <input type="text" class="form-control form-control-lg text-center"
                               value="${detail.icon}" maxlength="2"
                               onchange="updateContactDetail(${index}, 'icon', this.value)">
                        <small class="text-muted">Emoji</small>
                    </div>
                    <div class="col-md-3 mb-2">
                        <label class="form-label">Label <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" value="${detail.label}"
                               onchange="updateContactDetail(${index}, 'label', this.value)" required
                               placeholder="e.g., Email, LinkedIn">
                    </div>
                    <div class="col-md-4 mb-2">
                        <label class="form-label">Display Value <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" value="${detail.value}"
                               onchange="updateContactDetail(${index}, 'value', this.value)" required
                               placeholder="What visitors see">
                    </div>
                    <div class="col-md-3 mb-2">
                        <label class="form-label">Order</label>
                        <input type="number" class="form-control" value="${detail.order || index + 1}"
                               onchange="updateContactDetail(${index}, 'order', parseInt(this.value))" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 mb-2">
                        <label class="form-label">Link URL <span class="text-danger">*</span></label>
                        <input type="url" class="form-control" value="${detail.link}"
                               onchange="updateContactDetail(${index}, 'link', this.value)" required
                               placeholder="mailto:, tel:, or https://">
                        <small class="text-muted">Use mailto: for email, tel: for phone, https:// for websites</small>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-danger mt-2" onclick="removeContactDetail(${index})">
                    <i class="bi bi-trash"></i> Remove
                </button>
            </div>
        `;
        container.appendChild(div);
    });

    updateContactDetailsJSON();
}

function addContactDetail() {
    contactDetails.push({
        icon: 'ðŸ“§',
        label: '',
        value: '',
        link: '',
        order: contactDetails.length + 1
    });
    renderContactDetails();
}

function removeContactDetail(index) {
    contactDetails.splice(index, 1);
    contactDetails.forEach((d, i) => d.order = i + 1);
    renderContactDetails();
}

function updateContactDetail(index, field, value) {
    contactDetails[index][field] = value;
    updateContactDetailsJSON();
}

function updateContactDetailsJSON() {
    document.getElementById('contact-details-json').value = JSON.stringify(contactDetails);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    renderContactDetails();
});
</script>

<style>
.sticky-top {
    z-index: 100;
}
</style>
{% endblock %}
