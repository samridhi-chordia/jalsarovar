{% extends "base.html" %}

{% block title %}WQI Dashboard - Jal Sarovar{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        border-left: 4px solid #3b82f6;
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: #1e293b;
    }
    .stat-label {
        color: #64748b;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .compliance-badge-lg {
        font-size: 1.5rem;
        padding: 0.75rem 1.5rem;
    }
    .recent-calc-item {
        border-left: 3px solid transparent;
        padding-left: 1rem;
        transition: all 0.2s;
    }
    .recent-calc-item:hover {
        border-left-color: #3b82f6;
        background-color: #f8fafc;
    }
    .wqi-badge-excellent { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .wqi-badge-compliant { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
    .wqi-badge-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .wqi-badge-unsafe { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-3">
                <i class="bi bi-speedometer2"></i> WQI Dashboard
            </h1>
            <p class="text-muted">
                Overview of Water Quality Index calculations and trends
            </p>
        </div>
    </div>

    <!-- Time Period Stats -->
    <div class="row mb-4">
        <div class="col-12">
            <ul class="nav nav-pills" id="statsPeriodTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="stats-7d-tab" data-bs-toggle="pill" data-bs-target="#stats-7d" type="button">
                        Last 7 Days
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="stats-30d-tab" data-bs-toggle="pill" data-bs-target="#stats-30d" type="button">
                        Last 30 Days
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <div class="tab-content" id="statsPeriodTabContent">
        <!-- 7-Day Stats -->
        <div class="tab-pane fade show active" id="stats-7d" role="tabpanel">
            <div class="row mb-4">
                <!-- Total Calculations -->
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card stat-card shadow-sm">
                        <div class="card-body">
                            <div class="stat-label">Total Calculations</div>
                            <div class="stat-value">{{ stats_7d.total_calculations }}</div>
                            <small class="text-muted">
                                <i class="bi bi-calendar"></i> Last 7 days
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Average WQI -->
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card stat-card shadow-sm" style="border-left-color: #10b981;">
                        <div class="card-body">
                            <div class="stat-label">Average WQI</div>
                            <div class="stat-value">
                                {% if stats_7d.average_wqi %}
                                    {{ stats_7d.average_wqi }}
                                {% else %}
                                    --
                                {% endif %}
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-graph-up"></i> Mean quality score
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Safe Percentage -->
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card stat-card shadow-sm" style="border-left-color: #22c55e;">
                        <div class="card-body">
                            <div class="stat-label">Safe Water</div>
                            <div class="stat-value">
                                {% if stats_7d.safe_percentage %}
                                    {{ stats_7d.safe_percentage }}%
                                {% else %}
                                    --%
                                {% endif %}
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-shield-check"></i> WQI ≥ 70
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Compliance Distribution -->
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card stat-card shadow-sm" style="border-left-color: #f59e0b;">
                        <div class="card-body">
                            <div class="stat-label">Warnings</div>
                            <div class="stat-value">{{ stats_7d.warning_count + stats_7d.unsafe_count }}</div>
                            <small class="text-muted">
                                <i class="bi bi-exclamation-triangle"></i> Need attention
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Compliance Distribution -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Compliance Distribution (7 Days)</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3 mb-3">
                                    <div class="p-3 rounded" style="background: #ecfdf5;">
                                        <i class="bi bi-check-circle-fill text-success" style="font-size: 2rem;"></i>
                                        <h3 class="mt-2 mb-0">{{ stats_7d.excellent_count }}</h3>
                                        <p class="text-muted mb-0">Excellent</p>
                                        <small class="text-muted">WQI ≥ 90</small>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="p-3 rounded" style="background: #eff6ff;">
                                        <i class="bi bi-check-circle text-primary" style="font-size: 2rem;"></i>
                                        <h3 class="mt-2 mb-0">{{ stats_7d.compliant_count }}</h3>
                                        <p class="text-muted mb-0">Compliant</p>
                                        <small class="text-muted">WQI 70-89</small>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="p-3 rounded" style="background: #fef3c7;">
                                        <i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 2rem;"></i>
                                        <h3 class="mt-2 mb-0">{{ stats_7d.warning_count }}</h3>
                                        <p class="text-muted mb-0">Warning</p>
                                        <small class="text-muted">WQI 50-69</small>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="p-3 rounded" style="background: #fee2e2;">
                                        <i class="bi bi-x-circle-fill text-danger" style="font-size: 2rem;"></i>
                                        <h3 class="mt-2 mb-0">{{ stats_7d.unsafe_count }}</h3>
                                        <p class="text-muted mb-0">Unsafe</p>
                                        <small class="text-muted">WQI < 50</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 30-Day Stats -->
        <div class="tab-pane fade" id="stats-30d" role="tabpanel">
            <div class="row mb-4">
                <!-- Total Calculations -->
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card stat-card shadow-sm">
                        <div class="card-body">
                            <div class="stat-label">Total Calculations</div>
                            <div class="stat-value">{{ stats_30d.total_calculations }}</div>
                            <small class="text-muted">
                                <i class="bi bi-calendar"></i> Last 30 days
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Average WQI -->
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card stat-card shadow-sm" style="border-left-color: #10b981;">
                        <div class="card-body">
                            <div class="stat-label">Average WQI</div>
                            <div class="stat-value">
                                {% if stats_30d.average_wqi %}
                                    {{ stats_30d.average_wqi }}
                                {% else %}
                                    --
                                {% endif %}
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-graph-up"></i> Mean quality score
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Safe Percentage -->
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card stat-card shadow-sm" style="border-left-color: #22c55e;">
                        <div class="card-body">
                            <div class="stat-label">Safe Water</div>
                            <div class="stat-value">
                                {% if stats_30d.safe_percentage %}
                                    {{ stats_30d.safe_percentage }}%
                                {% else %}
                                    --%
                                {% endif %}
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-shield-check"></i> WQI ≥ 70
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Compliance Distribution -->
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card stat-card shadow-sm" style="border-left-color: #f59e0b;">
                        <div class="card-body">
                            <div class="stat-label">Warnings</div>
                            <div class="stat-value">{{ stats_30d.warning_count + stats_30d.unsafe_count }}</div>
                            <small class="text-muted">
                                <i class="bi bi-exclamation-triangle"></i> Need attention
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Compliance Distribution -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Compliance Distribution (30 Days)</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3 mb-3">
                                    <div class="p-3 rounded" style="background: #ecfdf5;">
                                        <i class="bi bi-check-circle-fill text-success" style="font-size: 2rem;"></i>
                                        <h3 class="mt-2 mb-0">{{ stats_30d.excellent_count }}</h3>
                                        <p class="text-muted mb-0">Excellent</p>
                                        <small class="text-muted">WQI ≥ 90</small>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="p-3 rounded" style="background: #eff6ff;">
                                        <i class="bi bi-check-circle text-primary" style="font-size: 2rem;"></i>
                                        <h3 class="mt-2 mb-0">{{ stats_30d.compliant_count }}</h3>
                                        <p class="text-muted mb-0">Compliant</p>
                                        <small class="text-muted">WQI 70-89</small>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="p-3 rounded" style="background: #fef3c7;">
                                        <i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 2rem;"></i>
                                        <h3 class="mt-2 mb-0">{{ stats_30d.warning_count }}</h3>
                                        <p class="text-muted mb-0">Warning</p>
                                        <small class="text-muted">WQI 50-69</small>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <div class="p-3 rounded" style="background: #fee2e2;">
                                        <i class="bi bi-x-circle-fill text-danger" style="font-size: 2rem;"></i>
                                        <h3 class="mt-2 mb-0">{{ stats_30d.unsafe_count }}</h3>
                                        <p class="text-muted mb-0">Unsafe</p>
                                        <small class="text-muted">WQI < 50</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Calculations -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Calculations</h5>
                    <a href="{{ url_for('wqi.wqi_calculator_page') }}" class="btn btn-sm btn-primary">
                        <i class="bi bi-calculator"></i> New Calculation
                    </a>
                </div>
                <div class="card-body">
                    {% if recent_calculations %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Device/Source</th>
                                        <th class="text-center">WQI Score</th>
                                        <th class="text-center">Compliance</th>
                                        <th class="text-center">Safe</th>
                                        <th class="text-end">Type</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for calc in recent_calculations %}
                                    <tr class="recent-calc-item">
                                        <td>
                                            <small class="text-muted">
                                                {{ calc.calculated_at.strftime('%Y-%m-%d %H:%M') }}
                                            </small>
                                        </td>
                                        <td>
                                            {% if calc.device_id %}
                                                <i class="bi bi-router"></i> {{ calc.device_id }}
                                            {% elif calc.site_id %}
                                                <i class="bi bi-geo-alt"></i> Site {{ calc.site_id }}
                                            {% elif calc.sample_id %}
                                                <i class="bi bi-droplet"></i> Sample {{ calc.sample_id }}
                                            {% else %}
                                                <i class="bi bi-calculator"></i> Manual
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            <strong>{{ calc.wqi_score }}</strong>
                                        </td>
                                        <td class="text-center">
                                            {% if calc.compliance_class == 'excellent' %}
                                                <span class="badge bg-success">Excellent</span>
                                            {% elif calc.compliance_class == 'compliant' %}
                                                <span class="badge bg-primary">Compliant</span>
                                            {% elif calc.compliance_class == 'warning' %}
                                                <span class="badge bg-warning">Warning</span>
                                            {% else %}
                                                <span class="badge bg-danger">Unsafe</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if calc.is_safe %}
                                                <i class="bi bi-check-circle-fill text-success"></i>
                                            {% else %}
                                                <i class="bi bi-x-circle-fill text-danger"></i>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            <small class="text-muted">{{ calc.calculation_type }}</small>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-inbox" style="font-size: 3rem; color: #cbd5e1;"></i>
                            <p class="text-muted mt-3">No WQI calculations yet</p>
                            <a href="{{ url_for('wqi.wqi_calculator_page') }}" class="btn btn-primary">
                                <i class="bi bi-calculator"></i> Calculate Your First WQI
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm bg-light">
                <div class="card-body">
                    <h5 class="mb-3"><i class="bi bi-lightning-fill"></i> Quick Actions</h5>
                    <div class="d-flex gap-2 flex-wrap">
                        <a href="{{ url_for('wqi.wqi_calculator_page') }}" class="btn btn-primary">
                            <i class="bi bi-calculator"></i> Calculate WQI
                        </a>
                        <a href="{{ url_for('wqi.wqi_info_page') }}" class="btn btn-outline-primary">
                            <i class="bi bi-info-circle"></i> WQI Methodology
                        </a>
                        <a href="{{ url_for('samples.index') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-droplet"></i> View Water Samples
                        </a>
                        <a href="{{ url_for('analytics.dashboard') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-graph-up"></i> Analytics Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
