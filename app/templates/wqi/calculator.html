{% extends "base.html" %}
{% block title %}WQI Calculator - Jal Sarovar | Water Quality Index Calculator{% endblock %}
{% block meta_description %}Calculate Water Quality Index (WQI) instantly. Free online tool to assess drinking water safety based on WHO and BIS standards. Check water quality parameters compliance.{% endblock %}
{% block meta_keywords %}WQI calculator, water quality index, water quality calculator, WHO water standards, BIS water standards, drinking water quality assessment, water safety calculator{% endblock %}
{% block og_title %}WQI Calculator - Jal Sarovar | Free Water Quality Index Tool{% endblock %}

{% block extra_css %}
<style>
    .wqi-score-display {
        font-size: 3rem;
        font-weight: bold;
        text-align: center;
        padding: 2rem;
        border-radius: 10px;
        margin: 1rem 0;
    }
    .wqi-excellent { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
    .wqi-compliant { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }
    .wqi-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
    .wqi-unsafe { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }

    .penalty-bar {
        height: 25px;
        background: #ef4444;
        border-radius: 5px;
        transition: width 0.5s ease;
    }

    .parameter-card {
        transition: transform 0.2s;
    }

    .parameter-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .result-section {
        display: none;
    }

    .loading-spinner {
        display: none;
    }

    .info-badge {
        cursor: help;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="mb-3">
                <i class="bi bi-calculator"></i> Water Quality Index Calculator
            </h1>
            <p class="text-muted">
                Enter water quality parameters to calculate the WQI score and compliance classification.
                This tool is free to use - no login required.
            </p>
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i>
                <strong>About WQI:</strong> The Water Quality Index (0-100) indicates overall water quality based on WHO/BIS standards.
                <a href="{{ url_for('wqi.info_page') }}">Learn more about WQI methodology</a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Input Form -->
        <div class="col-lg-6 col-md-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-input-cursor"></i> Water Quality Parameters</h5>
                </div>
                <div class="card-body">
                    <form id="wqiCalculatorForm">
                        <!-- pH Value -->
                        <div class="mb-3">
                            <label for="ph_value" class="form-label">
                                <i class="bi bi-circle-half"></i> pH Value
                                <span class="badge bg-secondary info-badge" title="Optimal range for drinking water">6.5 - 8.5</span>
                            </label>
                            <input type="number" class="form-control" id="ph_value" name="ph_value"
                                   step="0.1" min="0" max="14" placeholder="e.g., 7.2">
                            <div class="form-text">Acidity/alkalinity level of water</div>
                        </div>

                        <!-- TDS -->
                        <div class="mb-3">
                            <label for="tds_ppm" class="form-label">
                                <i class="bi bi-droplet"></i> TDS (Total Dissolved Solids)
                                <span class="badge bg-secondary info-badge" title="Maximum acceptable limit">ppm, max 500</span>
                            </label>
                            <input type="number" class="form-control" id="tds_ppm" name="tds_ppm"
                                   step="1" min="0" placeholder="e.g., 450">
                            <div class="form-text">Concentration of dissolved substances</div>
                        </div>

                        <!-- Turbidity -->
                        <div class="mb-3">
                            <label for="turbidity_ntu" class="form-label">
                                <i class="bi bi-cloud-haze"></i> Turbidity
                                <span class="badge bg-secondary info-badge" title="Maximum acceptable limit">NTU, max 5</span>
                            </label>
                            <input type="number" class="form-control" id="turbidity_ntu" name="turbidity_ntu"
                                   step="0.1" min="0" placeholder="e.g., 3.5">
                            <div class="form-text">Cloudiness or haziness of water</div>
                        </div>

                        <!-- Free Chlorine -->
                        <div class="mb-3">
                            <label for="free_chlorine" class="form-label">
                                <i class="bi bi-shield-check"></i> Free Chlorine
                                <span class="badge bg-secondary info-badge" title="Optimal range for disinfection">mg/L, 0.2 - 4.0</span>
                            </label>
                            <input type="number" class="form-control" id="free_chlorine" name="free_chlorine"
                                   step="0.01" min="0" placeholder="e.g., 0.5">
                            <div class="form-text">Disinfectant residual level</div>
                        </div>

                        <!-- Temperature -->
                        <div class="mb-3">
                            <label for="temperature_c" class="form-label">
                                <i class="bi bi-thermometer-half"></i> Temperature
                                <span class="badge bg-secondary info-badge" title="Optimal range">10 - 25 C</span>
                            </label>
                            <input type="number" class="form-control" id="temperature_c" name="temperature_c"
                                   step="0.1" min="0" max="100" placeholder="e.g., 22.0">
                            <div class="form-text">Water temperature in Celsius</div>
                        </div>

                        <!-- Total Coliform -->
                        <div class="mb-3">
                            <label for="total_coliform" class="form-label">
                                <i class="bi bi-bug"></i> Total Coliform
                                <span class="badge bg-secondary info-badge" title="Should be zero for safe water">CFU/100mL, ideal 0</span>
                            </label>
                            <input type="number" class="form-control" id="total_coliform" name="total_coliform"
                                   step="1" min="0" placeholder="e.g., 0">
                            <div class="form-text">Bacterial contamination indicator</div>
                        </div>

                        <!-- Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-calculator"></i> Calculate WQI
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="loadSampleData()">
                                <i class="bi bi-lightning"></i> Load Sample Data
                            </button>
                            <button type="reset" class="btn btn-outline-secondary" onclick="resetResults()">
                                <i class="bi bi-arrow-clockwise"></i> Reset Form
                            </button>
                        </div>
                    </form>

                    <!-- Loading Spinner -->
                    <div class="loading-spinner text-center mt-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Calculating...</span>
                        </div>
                        <p class="mt-2">Calculating WQI...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Display -->
        <div class="col-lg-6 col-md-12 mb-4">
            <div class="result-section">
                <!-- WQI Score Display -->
                <div class="card shadow-sm mb-3">
                    <div class="card-body">
                        <h5 class="text-center text-muted mb-3">Water Quality Index</h5>
                        <div id="wqiScoreDisplay" class="wqi-score-display wqi-excellent">
                            <div id="wqiScore">--</div>
                            <small id="wqiClass" style="font-size: 1rem;">--</small>
                        </div>
                        <div class="text-center mt-3">
                            <h5 id="safetyStatus" class="mb-0">
                                <span class="badge bg-success"><i class="bi bi-check-circle"></i> Safe to Drink</span>
                            </h5>
                        </div>
                    </div>
                </div>

                <!-- Penalty Breakdown -->
                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Penalty Breakdown</h5>
                    </div>
                    <div class="card-body">
                        <div id="penaltyBreakdown">
                            <!-- Will be populated by JavaScript -->
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between align-items-center">
                            <strong>Total Penalty:</strong>
                            <span id="totalPenalty" class="badge bg-danger">0 points</span>
                        </div>
                    </div>
                </div>

                <!-- Compliance Information -->
                <div class="card shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-info-circle"></i> Compliance Information</h5>
                    </div>
                    <div class="card-body" id="complianceInfo">
                        <!-- Will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Initial placeholder -->
            <div id="initialPlaceholder" class="card shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="bi bi-droplet-fill text-primary" style="font-size: 4rem;"></i>
                    <h4 class="mt-3">Enter Water Quality Parameters</h4>
                    <p class="text-muted">
                        Fill in the form on the left and click "Calculate WQI" to see results.
                        <br>You can also click "Load Sample Data" to try with example values.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- WQI Scale Reference -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="bi bi-rulers"></i> WQI Scale Reference</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3 mb-3">
                            <div class="p-3 rounded wqi-excellent">
                                <h4>90-100</h4>
                                <strong>Excellent</strong>
                                <p class="mb-0 small">Safe to drink</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="p-3 rounded wqi-compliant">
                                <h4>70-89</h4>
                                <strong>Compliant</strong>
                                <p class="mb-0 small">Safe to drink</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="p-3 rounded wqi-warning">
                                <h4>50-69</h4>
                                <strong>Warning</strong>
                                <p class="mb-0 small">Caution advised</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="p-3 rounded wqi-unsafe">
                                <h4>0-49</h4>
                                <strong>Unsafe</strong>
                                <p class="mb-0 small">Do not drink</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Sample data for quick testing
function loadSampleData() {
    document.getElementById('ph_value').value = '7.2';
    document.getElementById('tds_ppm').value = '450';
    document.getElementById('turbidity_ntu').value = '3.5';
    document.getElementById('free_chlorine').value = '0.5';
    document.getElementById('temperature_c').value = '22.0';
    document.getElementById('total_coliform').value = '0';
}

function resetResults() {
    document.querySelector('.result-section').style.display = 'none';
    document.getElementById('initialPlaceholder').style.display = 'block';
}

// Form submission
document.getElementById('wqiCalculatorForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    // Show loading spinner
    document.querySelector('.loading-spinner').style.display = 'block';
    document.querySelector('.result-section').style.display = 'none';
    document.getElementById('initialPlaceholder').style.display = 'none';

    // Collect form data
    const formData = {
        ph_value: parseFloat(document.getElementById('ph_value').value) || null,
        tds_ppm: parseFloat(document.getElementById('tds_ppm').value) || null,
        turbidity_ntu: parseFloat(document.getElementById('turbidity_ntu').value) || null,
        free_chlorine: parseFloat(document.getElementById('free_chlorine').value) || null,
        temperature_c: parseFloat(document.getElementById('temperature_c').value) || null,
        total_coliform: parseFloat(document.getElementById('total_coliform').value) || null
    };

    try {
        // Call API
        const response = await fetch('/wqi/calculate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });

        if (!response.ok) {
            throw new Error('Calculation failed');
        }

        const result = await response.json();

        // Display results
        displayResults(result);

    } catch (error) {
        alert('Error calculating WQI: ' + error.message);
        document.getElementById('initialPlaceholder').style.display = 'block';
    } finally {
        document.querySelector('.loading-spinner').style.display = 'none';
    }
});

function displayResults(result) {
    // Show results section
    document.querySelector('.result-section').style.display = 'block';
    document.getElementById('initialPlaceholder').style.display = 'none';

    // WQI Score
    document.getElementById('wqiScore').textContent = result.wqi_score;
    document.getElementById('wqiClass').textContent = result.compliance_class.toUpperCase();

    // Apply color based on compliance class
    const scoreDisplay = document.getElementById('wqiScoreDisplay');
    scoreDisplay.className = 'wqi-score-display wqi-' + result.compliance_class;

    // Safety status
    const safetyBadge = result.is_safe
        ? '<span class="badge bg-success"><i class="bi bi-check-circle"></i> Safe to Drink</span>'
        : '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> Unsafe - Do Not Drink</span>';
    document.getElementById('safetyStatus').innerHTML = safetyBadge;

    // Penalty breakdown
    const penaltyLabels = {
        'ph': 'pH',
        'tds': 'TDS',
        'turbidity': 'Turbidity',
        'chlorine': 'Chlorine',
        'temperature': 'Temperature',
        'coliform': 'Coliform'
    };

    const maxPenalty = Math.max(...Object.values(result.penalties), 1);
    const penaltyHtml = Object.entries(result.penalties)
        .filter(([key, value]) => value > 0)
        .map(([key, value]) => {
            const percentage = (value / maxPenalty) * 100;
            return `
                <div class="mb-2">
                    <div class="d-flex justify-content-between mb-1">
                        <span><strong>${penaltyLabels[key] || key}:</strong></span>
                        <span class="text-danger">-${value.toFixed(2)} points</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-danger" style="width: ${percentage}%"></div>
                    </div>
                </div>
            `;
        }).join('');

    document.getElementById('penaltyBreakdown').innerHTML = penaltyHtml || '<p class="text-success mb-0"><i class="bi bi-check-circle"></i> No penalties - excellent water quality!</p>';
    document.getElementById('totalPenalty').textContent = result.total_penalty.toFixed(2) + ' points';

    // Compliance information
    if (result.compliance_info) {
        const info = result.compliance_info;
        const infoHtml = `
            <h6 class="text-uppercase" style="color: ${info.color}">
                <i class="bi bi-shield-check"></i> ${info.class}
            </h6>
            <p>${info.description}</p>
            ${info.recommendations ? '<h6>Recommendations:</h6><ul class="mb-0">' +
                info.recommendations.map(r => '<li>' + r + '</li>').join('') +
                '</ul>' : ''}
        `;
        document.getElementById('complianceInfo').innerHTML = infoHtml;
    }

    // Scroll to results
    document.querySelector('.result-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
}
</script>
{% endblock %}
