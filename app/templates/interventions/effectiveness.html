{% extends "base.html" %}

{% block title %}Intervention Effectiveness - Jal Sarovar{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Breadcrumbs -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('interventions.index') }}">Interventions</a></li>
                    <li class="breadcrumb-item active">Effectiveness Dashboard</li>
                </ol>
            </nav>

            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">
                        <i class="bi bi-graph-up"></i> Intervention Effectiveness
                    </h2>
                    <small class="text-muted">Analysis of treatment outcomes and effectiveness</small>
                </div>
                <div>
                    <a href="{{ url_for('interventions.index') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Interventions
                    </a>
                </div>
            </div>

            <!-- Summary Stats -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card shadow-sm text-center bg-primary text-white">
                        <div class="card-body py-3">
                            <h2 class="mb-0">{{ summary_stats.total }}</h2>
                            <small>Total Interventions</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card shadow-sm text-center bg-success text-white">
                        <div class="card-body py-3">
                            <h2 class="mb-0">{{ summary_stats.completed }}</h2>
                            <small>Completed</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card shadow-sm text-center bg-info text-white">
                        <div class="card-body py-3">
                            <h2 class="mb-0">{{ summary_stats.avg_effectiveness }}%</h2>
                            <small>Avg Improvement</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card shadow-sm text-center">
                        <div class="card-body py-3">
                            <h2 class="mb-0">Rs {{ '{:,.0f}'.format(summary_stats.total_cost) }}</h2>
                            <small class="text-muted">Total Investment</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Effectiveness by Type -->
                <div class="col-md-6">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Effectiveness by Intervention Type</h5>
                        </div>
                        <div class="card-body">
                            {% if effectiveness_by_type %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Type</th>
                                            <th class="text-center">Count</th>
                                            <th class="text-center">Avg Improvement</th>
                                            <th class="text-end">Avg Cost (INR)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for itype, data in effectiveness_by_type.items() %}
                                        <tr>
                                            <td>
                                                <span class="badge bg-secondary">{{ intervention_types.get(itype, itype) }}</span>
                                            </td>
                                            <td class="text-center">{{ data.count }}</td>
                                            <td class="text-center">
                                                <span class="{% if data.avg_improvement > 0 %}text-success{% else %}text-danger{% endif %}">
                                                    {{ '{:+.1f}'.format(data.avg_improvement) }}%
                                                </span>
                                            </td>
                                            <td class="text-end">{{ '{:,.0f}'.format(data.avg_cost) }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="bi bi-inbox display-4 text-muted"></i>
                                <p class="text-muted mt-2">No completed interventions with effectiveness data yet.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Effectiveness by Type Chart -->
                    {% if effectiveness_by_type %}
                    <div class="card shadow-sm mb-4">
                        <div class="card-body">
                            <canvas id="effectivenessChart" height="250"></canvas>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Effectiveness by Method -->
                <div class="col-md-6">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-gear"></i> Effectiveness by Treatment Method</h5>
                        </div>
                        <div class="card-body">
                            {% if effectiveness_by_method %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Method</th>
                                            <th class="text-center">Count</th>
                                            <th class="text-center">Avg Improvement</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for method, data in effectiveness_by_method.items() %}
                                        <tr>
                                            <td>{{ method }}</td>
                                            <td class="text-center">{{ data.count }}</td>
                                            <td class="text-center">
                                                <div class="progress" style="height: 20px; min-width: 100px;">
                                                    <div class="progress-bar {% if data.avg_improvement > 50 %}bg-success{% elif data.avg_improvement > 0 %}bg-info{% else %}bg-danger{% endif %}"
                                                         style="width: {{ [data.avg_improvement, 100]|min }}%">
                                                        {{ '{:.1f}'.format(data.avg_improvement) }}%
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="bi bi-inbox display-4 text-muted"></i>
                                <p class="text-muted mt-2">No completed interventions with treatment methods yet.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Recent Completed Interventions -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="bi bi-clock-history"></i> Recent Completed</h5>
                            <a href="{{ url_for('interventions.index', status='completed') }}" class="btn btn-sm btn-outline-primary">
                                View All
                            </a>
                        </div>
                        <div class="card-body">
                            {% if recent_interventions %}
                            <div class="list-group list-group-flush">
                                {% for intervention in recent_interventions %}
                                <a href="{{ url_for('interventions.view_intervention', intervention_id=intervention.id) }}"
                                   class="list-group-item list-group-item-action">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>#{{ intervention.id }}</strong>
                                            {% if intervention.site %}
                                            - {{ intervention.site.site_name }}
                                            {% endif %}
                                            <br>
                                            <small class="text-muted">
                                                {{ intervention.intervention_type or 'Unknown type' }}
                                                {% if intervention.completed_date %}
                                                - {{ intervention.completed_date.strftime('%Y-%m-%d') }}
                                                {% endif %}
                                            </small>
                                        </div>
                                        <div class="text-end">
                                            {% if intervention.improvement_percent %}
                                            <span class="badge {% if intervention.improvement_percent > 0 %}bg-success{% else %}bg-danger{% endif %} fs-6">
                                                {{ '{:+.1f}'.format(intervention.improvement_percent) }}%
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </a>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="text-center py-4">
                                <i class="bi bi-inbox display-4 text-muted"></i>
                                <p class="text-muted mt-2">No completed interventions yet.</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cost-Effectiveness Analysis -->
            {% if effectiveness_by_type %}
            <div class="row">
                <div class="col-12">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0"><i class="bi bi-currency-rupee"></i> Cost-Effectiveness Analysis</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="costEffectivenessChart" height="150"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if effectiveness_by_type %}
<script>
    // Effectiveness by Type Chart
    const effectivenessCtx = document.getElementById('effectivenessChart').getContext('2d');
    new Chart(effectivenessCtx, {
        type: 'bar',
        data: {
            labels: [{% for itype in effectiveness_by_type %}'{{ intervention_types.get(itype, itype) }}'{% if not loop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                label: 'Average Improvement (%)',
                data: [{% for itype, data in effectiveness_by_type.items() %}{{ data.avg_improvement }}{% if not loop.last %}, {% endif %}{% endfor %}],
                backgroundColor: [{% for itype, data in effectiveness_by_type.items() %}'{{ "rgba(40, 167, 69, 0.7)" if data.avg_improvement > 0 else "rgba(220, 53, 69, 0.7)" }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                borderColor: [{% for itype, data in effectiveness_by_type.items() %}'{{ "#28a745" if data.avg_improvement > 0 else "#dc3545" }}'{% if not loop.last %}, {% endif %}{% endfor %}],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: 'Average Improvement by Intervention Type'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Improvement (%)'
                    }
                }
            }
        }
    });

    // Cost-Effectiveness Chart
    const costCtx = document.getElementById('costEffectivenessChart').getContext('2d');
    new Chart(costCtx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Interventions',
                data: [{% for itype, data in effectiveness_by_type.items() %}{x: {{ data.avg_cost }}, y: {{ data.avg_improvement }}, label: '{{ intervention_types.get(itype, itype) }}'}{% if not loop.last %}, {% endif %}{% endfor %}],
                backgroundColor: 'rgba(13, 110, 253, 0.7)',
                borderColor: '#0d6efd',
                pointRadius: 10,
                pointHoverRadius: 15
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                title: {
                    display: true,
                    text: 'Cost vs Effectiveness by Intervention Type'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.raw.label + ': Rs ' + context.raw.x.toLocaleString() + ' / ' + context.raw.y.toFixed(1) + '% improvement';
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Average Cost (INR)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Average Improvement (%)'
                    }
                }
            }
        }
    });
</script>
{% endif %}
{% endblock %}
