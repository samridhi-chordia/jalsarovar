{% extends "base.html" %}

{% block title %}{{ 'Edit' if intervention else 'New' }} Intervention - Jal Sarovar{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- Breadcrumbs -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('interventions.index') }}">Interventions</a></li>
                    <li class="breadcrumb-item active">{{ 'Edit' if intervention else 'New' }} Intervention</li>
                </ol>
            </nav>

            <!-- Page Header -->
            <div class="card shadow-sm mb-4">
                <div class="card-body bg-light">
                    <h2 class="mb-0">
                        <i class="bi bi-{{ 'pencil' if intervention else 'plus-circle' }}"></i>
                        {{ 'Edit' if intervention else 'Record New' }} Intervention
                    </h2>
                </div>
            </div>

            <!-- Intervention Form -->
            <form method="POST" action="{{ url_for('interventions.edit_intervention', intervention_id=intervention.id) if intervention else url_for('interventions.new_intervention') }}">
                <div class="row">
                    <!-- Left Column -->
                    <div class="col-md-8">
                        <!-- Basic Information -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Basic Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="site_id" class="form-label">
                                            <strong>Site</strong> <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="site_id" name="site_id" required>
                                            <option value="">-- Select Site --</option>
                                            {% for site in sites %}
                                            <option value="{{ site.id }}" {% if intervention and intervention.site_id == site.id %}selected{% endif %}>
                                                {{ site.site_name }} ({{ site.state }})
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="sample_id" class="form-label">Related Sample</label>
                                        <select class="form-select" id="sample_id" name="sample_id">
                                            <option value="">-- Optional --</option>
                                            {% for sample in samples %}
                                            <option value="{{ sample.id }}" {% if intervention and intervention.sample_id == sample.id %}selected{% endif %}>
                                                #{{ sample.id }} - {{ sample.collection_date.strftime('%Y-%m-%d') if sample.collection_date else 'No date' }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="intervention_type" class="form-label">
                                            <strong>Intervention Type</strong> <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="intervention_type" name="intervention_type" required>
                                            <option value="">-- Select Type --</option>
                                            {% for value, label in intervention_types %}
                                            <option value="{{ value }}" {% if intervention and intervention.intervention_type == value %}selected{% endif %}>
                                                {{ label }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="treatment_method_id" class="form-label">Treatment Method</label>
                                        <select class="form-select" id="treatment_method_id" name="treatment_method_id">
                                            <option value="">-- Optional --</option>
                                            {% for method in treatment_methods %}
                                            <option value="{{ method.id }}" {% if intervention and intervention.treatment_method_id == method.id %}selected{% endif %}>
                                                {{ method.method_name }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="intervention_date" class="form-label">
                                            <strong>Intervention Date</strong> <span class="text-danger">*</span>
                                        </label>
                                        <input type="date" class="form-control" id="intervention_date" name="intervention_date"
                                               value="{{ intervention.intervention_date.strftime('%Y-%m-%d') if intervention and intervention.intervention_date else '' }}" required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="status" class="form-label">
                                            <strong>Status</strong> <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="status" name="status" required>
                                            {% for value, label in status_choices %}
                                            <option value="{{ value }}" {% if intervention and intervention.status == value %}selected{% elif not intervention and value == 'planned' %}selected{% endif %}>
                                                {{ label }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="description" class="form-label">Description</label>
                                    <textarea class="form-control" id="description" name="description" rows="3"
                                              placeholder="Describe the intervention...">{{ intervention.description if intervention else '' }}</textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Implementation Details -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="bi bi-person-lines-fill"></i> Implementation Details</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="implemented_by" class="form-label">Implemented By</label>
                                        <input type="text" class="form-control" id="implemented_by" name="implemented_by"
                                               value="{{ intervention.implemented_by if intervention else '' }}"
                                               placeholder="Name of person/team">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="contractor" class="form-label">Contractor</label>
                                        <input type="text" class="form-control" id="contractor" name="contractor"
                                               value="{{ intervention.contractor if intervention else '' }}"
                                               placeholder="Contractor name (if applicable)">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="completed_date" class="form-label">Completion Date</label>
                                        <input type="date" class="form-control" id="completed_date" name="completed_date"
                                               value="{{ intervention.completed_date.strftime('%Y-%m-%d') if intervention and intervention.completed_date else '' }}">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Effectiveness Measurement -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Effectiveness Measurement</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <label for="parameter_targeted" class="form-label">Parameter Targeted</label>
                                        <select class="form-select" id="parameter_targeted" name="parameter_targeted">
                                            <option value="">-- Select --</option>
                                            {% for value, label in parameter_choices %}
                                            <option value="{{ value }}" {% if intervention and intervention.parameter_targeted == value %}selected{% endif %}>
                                                {{ label }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="before_value" class="form-label">Before Value</label>
                                        <input type="number" step="0.01" class="form-control" id="before_value" name="before_value"
                                               value="{{ intervention.before_value if intervention and intervention.before_value else '' }}"
                                               placeholder="e.g., 8.5">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="after_value" class="form-label">After Value</label>
                                        <input type="number" step="0.01" class="form-control" id="after_value" name="after_value"
                                               value="{{ intervention.after_value if intervention and intervention.after_value else '' }}"
                                               placeholder="e.g., 7.2">
                                    </div>
                                </div>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="effectiveness_rating" class="form-label">Effectiveness Rating (1-5)</label>
                                        <select class="form-select" id="effectiveness_rating" name="effectiveness_rating">
                                            <option value="">-- Rate --</option>
                                            <option value="1" {% if intervention and intervention.effectiveness_rating == 1 %}selected{% endif %}>1 - Ineffective</option>
                                            <option value="2" {% if intervention and intervention.effectiveness_rating == 2 %}selected{% endif %}>2 - Minimal Effect</option>
                                            <option value="3" {% if intervention and intervention.effectiveness_rating == 3 %}selected{% endif %}>3 - Moderate Effect</option>
                                            <option value="4" {% if intervention and intervention.effectiveness_rating == 4 %}selected{% endif %}>4 - Good Effect</option>
                                            <option value="5" {% if intervention and intervention.effectiveness_rating == 5 %}selected{% endif %}>5 - Excellent Effect</option>
                                        </select>
                                    </div>
                                    {% if intervention and intervention.improvement_percent %}
                                    <div class="col-md-6">
                                        <label class="form-label">Calculated Improvement</label>
                                        <div class="form-control bg-light">
                                            <span class="{% if intervention.improvement_percent > 0 %}text-success{% else %}text-danger{% endif %}">
                                                {{ '{:+.1f}'.format(intervention.improvement_percent) }}%
                                            </span>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="col-md-4">
                        <!-- Cost Information -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="bi bi-currency-rupee"></i> Cost Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="actual_cost_inr" class="form-label">Total Cost (INR)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">Rs</span>
                                        <input type="number" step="0.01" class="form-control" id="actual_cost_inr" name="actual_cost_inr"
                                               value="{{ intervention.actual_cost_inr if intervention and intervention.actual_cost_inr else '' }}"
                                               placeholder="0.00">
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="labor_cost_inr" class="form-label">Labor Cost (INR)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">Rs</span>
                                        <input type="number" step="0.01" class="form-control" id="labor_cost_inr" name="labor_cost_inr"
                                               value="{{ intervention.labor_cost_inr if intervention and intervention.labor_cost_inr else '' }}"
                                               placeholder="0.00">
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="material_cost_inr" class="form-label">Material Cost (INR)</label>
                                    <div class="input-group">
                                        <span class="input-group-text">Rs</span>
                                        <input type="number" step="0.01" class="form-control" id="material_cost_inr" name="material_cost_inr"
                                               value="{{ intervention.material_cost_inr if intervention and intervention.material_cost_inr else '' }}"
                                               placeholder="0.00">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Follow-up -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="bi bi-calendar-check"></i> Follow-up</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="follow_up_required" name="follow_up_required"
                                               {% if intervention and intervention.follow_up_required %}checked{% endif %}>
                                        <label class="form-check-label" for="follow_up_required">
                                            Follow-up Required
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="follow_up_date" class="form-label">Follow-up Date</label>
                                    <input type="date" class="form-control" id="follow_up_date" name="follow_up_date"
                                           value="{{ intervention.follow_up_date.strftime('%Y-%m-%d') if intervention and intervention.follow_up_date else '' }}">
                                </div>
                            </div>
                        </div>

                        <!-- Notes -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="bi bi-sticky"></i> Notes</h5>
                            </div>
                            <div class="card-body">
                                <textarea class="form-control" id="notes" name="notes" rows="4"
                                          placeholder="Additional notes...">{{ intervention.notes if intervention else '' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body d-flex justify-content-between">
                        <a href="{{ url_for('interventions.index') }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                        <div>
                            {% if intervention %}
                            <button type="button" class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                            {% endif %}
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> {{ 'Save Changes' if intervention else 'Create Intervention' }}
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

{% if intervention %}
<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> Confirm Delete</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this intervention?</p>
                <p class="text-muted small">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('interventions.delete_intervention', intervention_id=intervention.id) }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
